{"version":3,"sources":["../../lib/plugin.js"],"names":["chalk","require","_","updateNotifier","configureFetchDefaults","getLoggedInUser","openBrowser","sfePkgJson","errorHandler","logsCollection","login","logout","wrap","injectLogsIamRole","injectOutputOutputs","wrapClean","runPolicies","getCredentials","getAppUids","removeDestination","saveDeployment","createAndSetDeploymentUid","variables","generate","eventDict","configureDeployProfile","test","getDashboardUrl","setApiGatewayAccessLogFormat","interactiveCli","ServerlessEnterprisePlugin","constructor","sls","state","secretsUsed","Set","service","tenant","org","commands","usage","lifecycleEvents","enterprise","options","type","keys","join","shortcut","required","body","function","hooks","route","bind","variableResolvers","param","resolver","getValueFromDashboardParams","serviceName","isDisabledAtPrepopulation","secrets","output","getValueFromDashboardOutputs","pluginManager","plugins","plugin","name","app","values","command","configDependent","Object","assign","missing","push","length","cli","log","sfeEnabledHooks","match","RegExp","provider","variableSyntax","classes","Error","hook","enterpriseEnabled","includes","errorMessage","process","env","CI","console","yellow","appUid","tenantUid","asyncInit","processedInput","help","initializeServiceConfiguration","initializeProjectChoices","filter","value","missingConfigSettings","user","currentCommand","SERVERLESS_ACCESS_KEY","getProvider","isStandaloneExecutable","updates","pkg","interval","update","module","exports"],"mappings":"AAAA;;;;;;AAEA,MAAMA,KAAK,GAAGC,OAAO,CAAC,OAAD,CAArB;;AACA,MAAMC,CAAC,GAAGD,OAAO,CAAC,QAAD,CAAjB;;AACA,MAAME,cAAc,GAAGF,OAAO,CAAC,iBAAD,CAA9B;;iBAKIA,OAAO,CAAC,0BAAD,C;MAHTG,sB,YAAAA,sB;MACAC,e,YAAAA,e;MACAC,W,YAAAA,W;;AAEF,MAAMC,UAAU,GAAGN,OAAO,CAAC,YAAD,CAA1B;;AACA,MAAMO,YAAY,GAAGP,OAAO,CAAC,gBAAD,CAA5B;;AACA,MAAMQ,cAAc,GAAGR,OAAO,CAAC,kBAAD,CAA9B;;AACA,MAAMS,KAAK,GAAGT,OAAO,CAAC,SAAD,CAArB;;AACA,MAAMU,MAAM,GAAGV,OAAO,CAAC,UAAD,CAAtB;;AACA,MAAMW,IAAI,GAAGX,OAAO,CAAC,QAAD,CAApB;;AACA,MAAMY,iBAAiB,GAAGZ,OAAO,CAAC,qBAAD,CAAjC;;AACA,MAAMa,mBAAmB,GAAGb,OAAO,CAAC,uBAAD,CAAnC;;AACA,MAAMc,SAAS,GAAGd,OAAO,CAAC,aAAD,CAAzB;;AACA,MAAMe,WAAW,GAAGf,OAAO,CAAC,cAAD,CAA3B;;AACA,MAAMgB,cAAc,GAAGhB,OAAO,CAAC,eAAD,CAA9B;;AACA,MAAMiB,UAAU,GAAGjB,OAAO,CAAC,WAAD,CAA1B;;AACA,MAAMkB,iBAAiB,GAAGlB,OAAO,CAAC,qBAAD,CAAjC;;kBACsDA,OAAO,CAAC,cAAD,C;MAArDmB,c,aAAAA,c;MAAgBC,yB,aAAAA,yB;;AACxB,MAAMC,SAAS,GAAGrB,OAAO,CAAC,aAAD,CAAzB;;kBACgCA,OAAO,CAAC,iBAAD,C;MAA/BsB,Q,aAAAA,Q;MAAUC,S,aAAAA,S;;kBACiBvB,OAAO,CAAC,iBAAD,C;MAAlCwB,sB,aAAAA,sB;;kBACSxB,OAAO,CAAC,QAAD,C;MAAhByB,I,aAAAA,I;;kBACoBzB,OAAO,CAAC,aAAD,C;MAA3B0B,e,aAAAA,e;;AACR,MAAMC,4BAA4B,GAAG3B,OAAO,CAAC,gCAAD,CAA5C;;AACA,MAAM4B,cAAc,GAAG5B,OAAO,CAAC,kBAAD,CAA9B;AAEA;;;;;AAIA,MAAM6B,0BAAN,CAAiC;AAC/BC,EAAAA,WAAW,CAACC,GAAD,EAAM;AACf,SAAKA,GAAL,GAAWA,GAAX,CADe,CAGf;;AACA,SAAKC,KAAL,GAAa,EAAb,CAJe,CAIE;;AACjB,SAAKA,KAAL,CAAWC,WAAX,GAAyB,IAAIC,GAAJ,EAAzB,CALe,CAOf;;AACAH,IAAAA,GAAG,CAACI,OAAJ,CAAYC,MAAZ,GAAqBL,GAAG,CAACI,OAAJ,CAAYE,GAAZ,IAAmBN,GAAG,CAACI,OAAJ,CAAYC,MAApD;AAEAjC,IAAAA,sBAAsB,GAVP,CAYf;;AACA,SAAKmC,QAAL,GAAgB;AACd,eAAS;AACPC,QAAAA,KAAK,EAAE,iCADA;AAEPC,QAAAA,eAAe,EAAE,CAAC,OAAD,CAFV;AAGPC,QAAAA,UAAU,EAAE;AAHL,OADK;AAMd,gBAAU;AACRF,QAAAA,KAAK,EAAE,wBADC;AAERC,QAAAA,eAAe,EAAE,CAAC,QAAD,CAFT;AAGRC,QAAAA,UAAU,EAAE;AAHJ,OANI;AAWd,wBAAkB;AAChBF,QAAAA,KAAK,EAAE,gBADS;AAEhBC,QAAAA,eAAe,EAAE,CAAC,gBAAD,CAFD;AAGhBE,QAAAA,OAAO,EAAE;AACPC,UAAAA,IAAI,EAAE;AACJJ,YAAAA,KAAK,EAAG,uBAAsBtC,CAAC,CAAC2C,IAAF,CAAOrB,SAAP,EAAkBsB,IAAlB,CAAuB,IAAvB,CAA6B,iBADvD;AAEJC,YAAAA,QAAQ,EAAE,GAFN;AAGJC,YAAAA,QAAQ,EAAE;AAHN,WADC;AAMPC,UAAAA,IAAI,EAAE;AACJT,YAAAA,KAAK,EAAE,6DADH;AAEJO,YAAAA,QAAQ,EAAE;AAFN;AANC,SAHO;AAchBL,QAAAA,UAAU,EAAE;AAdI,OAXJ;AA2Bd,cAAQ;AACNF,QAAAA,KAAK,EAAE,gBADD;AAENC,QAAAA,eAAe,EAAE,CAAC,MAAD,CAFX;AAGNE,QAAAA,OAAO,EAAE;AACPO,UAAAA,QAAQ,EAAE;AACRV,YAAAA,KAAK,EAAE,8BADC;AAERO,YAAAA,QAAQ,EAAE;AAFF,WADH;AAKPrB,UAAAA,IAAI,EAAE;AACJc,YAAAA,KAAK,EAAE,gCADH;AAEJO,YAAAA,QAAQ,EAAE;AAFN;AALC,SAHH;AAaNL,QAAAA,UAAU,EAAE;AAbN,OA3BM;AA0Cd,mBAAa;AACXF,QAAAA,KAAK,EAAE,+BADI;AAEXC,QAAAA,eAAe,EAAE,CAAC,WAAD,CAFN;AAGXC,QAAAA,UAAU,EAAE;AAHD;AA1CC,KAAhB;AAgDA,SAAKS,KAAL,GAAa;AACX,qBAAe,KAAKC,KAAL,CAAW,aAAX,EAA0BC,IAA1B,CAA+B,IAA/B,CADJ;AAEX,uBAAiB,KAAKD,KAAL,CAAW,eAAX,EAA4BC,IAA5B,CAAiC,IAAjC,CAFN;AAGX,uCAAiC,KAAKD,KAAL,CAAW,+BAAX,EAA4CC,IAA5C,CAAiD,IAAjD,CAHtB;AAIX,mBAAa,KAAKD,KAAL,CAAW,WAAX,EAAwBC,IAAxB,CAA6B,IAA7B,CAJF;AAKX,6BAAuB,KAAKD,KAAL,CAAW,qBAAX,EAAkCC,IAAlC,CAAuC,IAAvC,CALZ;AAMX;AACA,2CAAqC,KAAKD,KAAL,CAAW,mCAAX,EAAgDC,IAAhD,CACnC,IADmC;AAP1B,KAAb;AAWA,SAAKC,iBAAL,GAAyB;AACvBC,MAAAA,KAAK,EAAE;AACLC,QAAAA,QAAQ,EAAElC,SAAS,CAACmC,2BAAV,CAAsC,IAAtC,CADL;AAELC,QAAAA,WAAW,EAAE,uBAFR;AAGLC,QAAAA,yBAAyB,EAAE;AAHtB,OADgB;AAMvBC,MAAAA,OAAO,EAAE;AACPJ,QAAAA,QAAQ,EAAElC,SAAS,CAACmC,2BAAV,CAAsC,IAAtC,CADH;AAEPC,QAAAA,WAAW,EAAE,oBAFN;AAGPC,QAAAA,yBAAyB,EAAE;AAHpB,OANc;AAWvBE,MAAAA,MAAM,EAAE;AACNL,QAAAA,QAAQ,EAAElC,SAAS,CAACwC,4BAAV,CAAuC,IAAvC,CADJ;AAENJ,QAAAA,WAAW,EAAE,oBAFP;AAGNC,QAAAA,yBAAyB,EAAE;AAHrB,OAXe;AAgBvB1B,MAAAA,KAAK,EAAE;AACLuB,QAAAA,QAAQ,EAAElC,SAAS,CAACwC,4BAAV,CAAuC,IAAvC,CADL;AAELJ,QAAAA,WAAW,EAAE,oBAFR;AAGLC,QAAAA,yBAAyB,EAAE;AAHtB;AAhBgB,KAAzB,CAxEe,CA+Ff;;AA/Fe;AAAA;AAAA;;AAAA;AAgGf,2BAAqB3B,GAAG,CAAC+B,aAAJ,CAAkBC,OAAvC,8HAAgD;AAAA,cAArCC,MAAqC;;AAC9C,YAAIA,MAAM,CAAClC,WAAP,CAAmBmC,IAAnB,KAA4B,gBAA5B,IAAgDD,MAAM,CAAC1B,QAA3D,EAAqE;AACnE,cAAI,CAAC0B,MAAM,CAAC1B,QAAP,CAAgBV,cAAhB,CAA+Bc,OAApC,EAA6C;AAC3CsB,YAAAA,MAAM,CAAC1B,QAAP,CAAgBV,cAAhB,CAA+Bc,OAA/B,GAAyC,EAAzC;AACD;;AACDsB,UAAAA,MAAM,CAAC1B,QAAP,CAAgBV,cAAhB,CAA+Bc,OAA/B,CAAuCwB,GAAvC,GAA6C;AAAE3B,YAAAA,KAAK,EAAE;AAAT,WAA7C;AACAyB,UAAAA,MAAM,CAAC1B,QAAP,CAAgBV,cAAhB,CAA+Bc,OAA/B,CAAuCL,GAAvC,GAA6C;AAAEE,YAAAA,KAAK,EAAE;AAAT,WAA7C;AACD,SAND,MAMO,IAAIyB,MAAM,CAAC1B,QAAX,EAAqB;AAAA;AAAA;AAAA;;AAAA;AAC1B,kCAAsBrC,CAAC,CAACkE,MAAF,CAASH,MAAM,CAAC1B,QAAhB,CAAtB,mIAAiD;AAAA,oBAAtC8B,OAAsC;;AAC/C,kBAAIA,OAAO,CAACC,eAAZ,EAA6B;AAC3BD,gBAAAA,OAAO,CAAC1B,OAAR,CAAgBwB,GAAhB,GAAsB;AAAE3B,kBAAAA,KAAK,EAAE;AAAT,iBAAtB;AACA6B,gBAAAA,OAAO,CAAC1B,OAAR,CAAgBL,GAAhB,GAAsB;AAAEE,kBAAAA,KAAK,EAAE;AAAT,iBAAtB;AACD;AACF;AANyB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAO3B;AACF,OA/Gc,CAgHf;AACA;;AAjHe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAkHf,4BAAsBtC,CAAC,CAACkE,MAAF,CAASpC,GAAG,CAAC+B,aAAJ,CAAkBxB,QAA3B,CAAtB,mIAA4D;AAAA,cAAjD8B,OAAiD;;AAC1D,YAAIA,OAAO,CAACC,eAAZ,EAA6B;AAC3BD,UAAAA,OAAO,CAAC1B,OAAR,CAAgBwB,GAAhB,GAAsB;AAAE3B,YAAAA,KAAK,EAAE;AAAT,WAAtB;AACA6B,UAAAA,OAAO,CAAC1B,OAAR,CAAgBL,GAAhB,GAAsB;AAAEE,YAAAA,KAAK,EAAE;AAAT,WAAtB;AACD;AACF,OAvHc,CAyHf;;AAzHe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA0Hf+B,IAAAA,MAAM,CAACC,MAAP,CAAc,KAAKrB,KAAnB,EAA0BtB,cAAc,CAAC,IAAD,CAAxC,EA1He,CA4Hf;;AACA,UAAM4C,OAAO,GAAG,EAAhB;;AACA,QAAI,CAACzC,GAAG,CAACI,OAAJ,CAAYC,MAAjB,EAAyB;AACvBoC,MAAAA,OAAO,CAACC,IAAR,CAAa,QAAb;AACD;;AACD,QAAI,CAAC1C,GAAG,CAACI,OAAJ,CAAY+B,GAAjB,EAAsB;AACpBM,MAAAA,OAAO,CAACC,IAAR,CAAa,KAAb;AACD;;AACD,QAAI,CAAC1C,GAAG,CAACI,OAAJ,CAAYA,OAAjB,EAA0B;AACxBqC,MAAAA,OAAO,CAACC,IAAR,CAAa,SAAb;AACD;;AACD,QAAID,OAAO,CAACE,MAAR,GAAiB,CAArB,EAAwB;AACtB;AACAJ,MAAAA,MAAM,CAACC,MAAP,CAAc,KAAKrB,KAAnB,EAA0B;AACxB,6CAAqC,MACnCnB,GAAG,CAAC4C,GAAJ,CAAQC,GAAR,CACE,gFADF;AAFsB,OAA1B;AAMA,WAAKC,eAAL,GAAuB,EAAvB;AACD,KATD,MASO;AACL,UACE9C,GAAG,CAACI,OAAJ,CAAY+B,GAAZ,CAAgBY,KAAhB,CAAsB,IAAIC,MAAJ,CAAWhD,GAAG,CAACI,OAAJ,CAAY6C,QAAZ,CAAqBC,cAAhC,CAAtB,KACAlD,GAAG,CAACI,OAAJ,CAAYC,MAAZ,CAAmB0C,KAAnB,CAAyB,IAAIC,MAAJ,CAAWhD,GAAG,CAACI,OAAJ,CAAY6C,QAAZ,CAAqBC,cAAhC,CAAzB,CAFF,EAGE;AACA,cAAM,IAAI,KAAKlD,GAAL,CAASmD,OAAT,CAAiBC,KAArB,CACJ,2EADI,CAAN;AAGD;;AAED,WAAKN,eAAL,GAAuB;AACrB,oDAA4C,KAAK1B,KAAL,CAC1C,0CAD0C,EAE1CC,IAF0C,CAErC,IAFqC,CADvB;AAIrB,mDAA2C,KAAKD,KAAL,CACzC,yCADyC,EAEzCC,IAFyC,CAEpC,IAFoC,CAJtB;AAOrB,kDAA0C,KAAKD,KAAL,CACxC,wCADwC,EAExCC,IAFwC,CAEnC,IAFmC,CAPrB;AAUrB,iDAAyC,KAAKD,KAAL,CACvC,uCADuC,EAEvCC,IAFuC,CAElC,IAFkC,CAVpB;AAarB,sCAA8B,KAAKD,KAAL,CAAW,4BAAX,EAAyCC,IAAzC,CAA8C,IAA9C,CAbT;AAcrB,wDAAgD,KAAKD,KAAL,CAC9C,8CAD8C,EAE9CC,IAF8C,CAEzC,IAFyC,CAd3B;AAiBrB,gCAAwB,KAAKD,KAAL,CAAW,sBAAX,EAAmCC,IAAnC,CAAwC,IAAxC,CAjBH;AAkBrB,gDAAwC,KAAKD,KAAL,CACtC,sCADsC,EAEtCC,IAFsC,CAEjC,IAFiC,CAlBnB;AAqBrB,iCAAyB,KAAKD,KAAL,CAAW,uBAAX,EAAoCC,IAApC,CAAyC,IAAzC,CArBJ;AAsBrB,+BAAuB,KAAKD,KAAL,CAAW,qBAAX,EAAkCC,IAAlC,CAAuC,IAAvC,CAtBF;AAuBrB,4BAAoB,KAAKD,KAAL,CAAW,kBAAX,EAA+BC,IAA/B,CAAoC,IAApC,CAvBC;AAwBrB,2BAAmB,KAAKD,KAAL,CAAW,iBAAX,EAA8BC,IAA9B,CAAmC,IAAnC,CAxBE;AAyBrB,4BAAoB,KAAKD,KAAL,CAAW,kBAAX,EAA+BC,IAA/B,CAAoC,IAApC,CAzBC;AA0BrB,kCAA0B,KAAKD,KAAL,CAAW,wBAAX,EAAqCC,IAArC,CAA0C,IAA1C,CA1BL;AA2BrB,gCAAwB,KAAKD,KAAL,CAAW,sBAAX,EAAmCC,IAAnC,CAAwC,IAAxC,CA3BH;AA4BrB,+BAAuB,KAAKD,KAAL,CAAW,qBAAX,EAAkCC,IAAlC,CAAuC,IAAvC,CA5BF;AA6BrB,qCAA6B,KAAKD,KAAL,CAAW,2BAAX,EAAwCC,IAAxC,CAA6C,IAA7C,CA7BR;AA8BrB,qCAA6B,KAAKD,KAAL,CAAW,2BAAX,EAAwCC,IAAxC,CAA6C,IAA7C,CA9BR;AA+BrB,+CAAuC,KAAKD,KAAL,CACrC,qCADqC,EAErCC,IAFqC,CAEhC,IAFgC;AA/BlB,OAAvB,CAVK,CA6CL;;AACAkB,MAAAA,MAAM,CAACC,MAAP,CAAc,KAAKrB,KAAnB,EAA0B,KAAK2B,eAA/B;AACD;AACF;AAED;;;;;AAIA1B,EAAAA,KAAK,CAACiC,IAAD,EAAO;AAAA;;AACV;AAAA;AAAA,wBAAO,aAAY;AACjB;AACA,YAAI,CAAC,KAAI,CAACrD,GAAL,CAASsD,iBAAV,IAA+BpF,CAAC,CAAC2C,IAAF,CAAO,KAAI,CAACiC,eAAZ,EAA6BS,QAA7B,CAAsCF,IAAtC,CAAnC,EAAgF;AAC9E,gBAAMG,YAAY,GAAGC,OAAO,CAACC,GAAR,CAAYC,EAAZ,GACjB,0HADiB,GAEjB,qEAFJ;AAGAC,UAAAA,OAAO,CAACf,GAAR,CAAY,EAAZ,EAJ8E,CAI7D;;AACjB,UAAA,KAAI,CAAC7C,GAAL,CAAS4C,GAAT,CAAaC,GAAb,CAAiBW,YAAjB;;AACA,gBAAM,IAAI,KAAI,CAACxD,GAAL,CAASmD,OAAT,CAAiBC,KAArB,CAA2BI,YAA3B,CAAN;AACD;;AAED,gBAAQH,IAAR;AACE,eAAK,0CAAL;AACEd,YAAAA,MAAM,CAACC,MAAP,CACE,KAAI,CAACxC,GAAL,CAASI,OADX,SAEQlB,UAAU,CAAC,KAAI,CAACc,GAAL,CAASI,OAAT,CAAiBC,MAAlB,EAA0B,KAAI,CAACL,GAAL,CAASI,OAAT,CAAiB+B,GAA3C,CAFlB;AAIA9C,YAAAA,yBAAyB,CAAC,KAAD,CAAzB;AACA,kBAAMT,IAAI,CAAC,KAAD,CAAV;AACA,kBAAMC,iBAAiB,CAAC,KAAD,CAAvB;AACA,kBAAMC,mBAAmB,CAAC,KAAD,CAAzB;AACA,kBAAMc,4BAA4B,CAAC,KAAD,CAAlC;AACA;;AACF,eAAK,yCAAL;AACE,kBAAMb,SAAS,CAAC,KAAD,CAAf;AACA;;AACF,eAAK,wCAAL;AACEM,YAAAA,yBAAyB,CAAC,KAAD,CAAzB;AACA,kBAAMT,IAAI,CAAC,KAAD,CAAV;AACA;;AACF,eAAK,uCAAL;AACE,kBAAMG,SAAS,CAAC,KAAD,CAAf;AACA;;AACF,eAAK,8CAAL;AACE,kBAAME,cAAc,CAAC,KAAD,CAApB;AACA,kBAAMR,cAAc,CAAC,KAAD,CAApB;AACA;;AACF,eAAK,sBAAL;AACE,YAAA,KAAI,CAACiC,UAAL,GAAkB;AAChBlC,cAAAA,YAAY,EAAEA,YAAY,CAAC,KAAD,CADV,CACkB;;AADlB,aAAlB;AAGA,kBAAMQ,WAAW,CAAC,KAAD,CAAjB;AACA;;AACF,eAAK,sCAAL;AACE;;AACF,eAAK,mCAAL;AACE,gBAAI,CAAC,KAAI,CAACgB,GAAL,CAASsD,iBAAd,EAAiC;AAC/B,cAAA,KAAI,CAACtD,GAAL,CAAS4C,GAAT,CAAaC,GAAb,CACE,gFADF;AAGD,aAJD,MAIO;AACL,oBAAMzD,cAAc,CAAC,KAAD,CAApB;AACD;;AACD;;AACF,eAAK,kBAAL;AACE,kBAAMH,cAAc,CAAC,KAAD,CAApB;AACA;;AACF,eAAK,iBAAL;AACE;AACA2E,YAAAA,OAAO,CAACf,GAAR,CACE7E,KAAK,CAAC6F,MAAN,CACG,6DAA4DlE,eAAe,CAAC,KAAD,CAAO,EADrF,CADF;AAKA;;AACF,eAAK,qBAAL;AACErB,YAAAA,WAAW,CAACqB,eAAe,CAAC,KAAD,CAAhB,CAAX;AACA;;AACF,eAAK,kBAAL;AACE,kBAAMV,cAAc,CAAC,KAAD,CAApB;AACA;;AACF,eAAK,wBAAL;AACE,kBAAMA,cAAc,CAAC,KAAD,CAApB;AACA;;AACF,eAAK,sBAAL;AACE,kBAAMA,cAAc,CAAC,KAAD,CAApB;AACA;;AACF,eAAK,qBAAL;AACEsD,YAAAA,MAAM,CAACC,MAAP,CACE,KAAI,CAACxC,GAAL,CAASI,OADX,SAEQlB,UAAU,CAAC,KAAI,CAACc,GAAL,CAASI,OAAT,CAAiBC,MAAlB,EAA0B,KAAI,CAACL,GAAL,CAASI,OAAT,CAAiB+B,GAA3C,CAFlB;AAIA,kBAAMhD,iBAAiB,CAAC,KAAD,CAAvB;AACA,kBAAMC,cAAc,CAAC,KAAD,EAAO,IAAP,CAApB;AACA;;AACF,eAAK,4BAAL;AACEmD,YAAAA,MAAM,CAACC,MAAP,CAAc,KAAI,CAACxC,GAAL,CAASI,OAAvB,EAAgC;AAC9B0D,cAAAA,MAAM,EAAE,oBADsB;AAE9BC,cAAAA,SAAS,EAAE;AAFmB,aAAhC;AAIA,kBAAMnF,IAAI,CAAC,KAAD,CAAV;AACA;;AACF,eAAK,2BAAL;AACE,kBAAMG,SAAS,CAAC,KAAD,CAAf;AACA;;AACF,eAAK,2BAAL;AACE;AACA;;AACF,eAAK,qCAAL;AACE;AACA;;AACF,eAAK,aAAL;AACE,kBAAML,KAAK,CAAC,KAAD,CAAX;AACA;;AACF,eAAK,eAAL;AACE,kBAAMC,MAAM,CAAC,KAAD,CAAZ;AACA;;AACF,eAAK,+BAAL;AACE,kBAAMY,QAAQ,CAAC,KAAD,CAAd;AACA;;AACF,eAAK,WAAL;AACE,kBAAMG,IAAI,CAAC,KAAD,CAAV;AACA;;AACF;AAtGF;AAwGD,OAnHD;AAAA;AAoHD;;AAEKsE,EAAAA,SAAN,GAAkB;AAAA;;AAAA;AAChB,UACE,MAAI,CAAChE,GAAL,CAASiE,cAAT,CAAwBtD,OAAxB,CAAgC,kBAAhC,KACA,MAAI,CAACX,GAAL,CAASiE,cAAT,CAAwBtD,OAAxB,CAAgCuD,IAFlC,EAGE;AACA;AACD,OANe,CAOhB;;;AACA,UAAI,MAAI,CAAClE,GAAL,CAASH,cAAT,IAA2B,MAAI,CAACG,GAAL,CAASH,cAAT,CAAwBsE,8BAAvD,EAAuF;AACrF,QAAA,MAAI,CAACnE,GAAL,CAASH,cAAT,CAAwBsE,8BAAxB,CAAuDC,wBAAvD,GAAkF,MAAI,CAACpE,GAAL,CAASH,cAAT,CAAwBsE,8BAAxB,CAAuDC,wBAAvD,CAAgFC,MAAhF,CAChF,CAAC;AAAEC,UAAAA;AAAF,SAAD,KAAe,CAAC,YAAD,EAAe,aAAf,EAA8B,YAA9B,EAA4Cf,QAA5C,CAAqDe,KAArD,CADiE,CAAlF;AAGD,OAZe,CAchB;;;AACA,UAAI,CAAC,MAAI,CAACtE,GAAL,CAASH,cAAd,EAA8B;AAC5B,YAAI,MAAI,CAACG,GAAL,CAASiE,cAAT,CAAwBtD,OAAxB,CAAgCL,GAApC,EAAyC;AACvC,UAAA,MAAI,CAACN,GAAL,CAASI,OAAT,CAAiBC,MAAjB,GAA0B,MAAI,CAACL,GAAL,CAASiE,cAAT,CAAwBtD,OAAxB,CAAgCL,GAA1D;AACD;;AACD,YAAI,MAAI,CAACN,GAAL,CAASiE,cAAT,CAAwBtD,OAAxB,CAAgCwB,GAApC,EAAyC;AACvC,UAAA,MAAI,CAACnC,GAAL,CAASI,OAAT,CAAiB+B,GAAjB,GAAuB,MAAI,CAACnC,GAAL,CAASiE,cAAT,CAAwBtD,OAAxB,CAAgCwB,GAAvD;AACD;AACF;;AACD,YAAMoC,qBAAqB,GAAG,EAA9B;;AACA,UAAI,CAAC,MAAI,CAACvE,GAAL,CAASI,OAAT,CAAiBC,MAAtB,EAA8B;AAC5BkE,QAAAA,qBAAqB,CAAC7B,IAAtB,CAA2B,QAA3B;AACD;;AACD,UAAI,CAAC,MAAI,CAAC1C,GAAL,CAASI,OAAT,CAAiB+B,GAAtB,EAA2B;AACzBoC,QAAAA,qBAAqB,CAAC7B,IAAtB,CAA2B,KAA3B;AACD;;AACD,UAAI,CAAC,MAAI,CAAC1C,GAAL,CAASI,OAAT,CAAiBA,OAAtB,EAA+B;AAC7BmE,QAAAA,qBAAqB,CAAC7B,IAAtB,CAA2B,SAA3B;AACD;;AACD,YAAM8B,IAAI,GAAGnG,eAAe,EAA5B;AACA,YAAMoG,cAAc,GAAG,MAAI,CAACzE,GAAL,CAASiE,cAAT,CAAwB1D,QAAxB,CAAiC,CAAjC,CAAvB;;AACA,UACEgE,qBAAqB,CAAC5B,MAAtB,KAAiC,CAAjC,KACC6B,IAAI,IAAIf,OAAO,CAACC,GAAR,CAAYgB,qBADrB,KAEA,CAAC,CAAC,OAAD,EAAU,QAAV,EAAoB,gBAApB,EAAsCnB,QAAtC,CAA+CkB,cAA/C,CAHH,EAIE;AACA,QAAA,MAAI,CAACzE,GAAL,CAASsD,iBAAT,GAA6B,IAA7B;AACD,OAzCe,CA0ChB;AACA;AACA;;;AACA,MAAA,MAAI,CAACL,QAAL,GAAgB,MAAI,CAACjD,GAAL,CAAS2E,WAAT,CAAqB,KAArB,CAAhB;;AACA,UACE,CAAC,MAAI,CAAC3E,GAAL,CAASH,cAAV,IACA,MAAI,CAACG,GAAL,CAASsD,iBADT,IAEA,CAAC,MAAI,CAACtD,GAAL,CAAS4E,sBAHZ,EAIE;AACA,cAAMC,OAAO,GAAG1G,cAAc,CAAC;AAAE2G,UAAAA,GAAG,EAAEvG,UAAP;AAAmBwG,UAAAA,QAAQ,EAAE;AAA7B,SAAD,CAA9B;;AACA,YAAIF,OAAO,CAACG,MAAZ,EAAoB;AAClB,UAAA,MAAI,CAAChF,GAAL,CAAS4C,GAAT,CAAaC,GAAb,CACE,kEACE,iDAFJ;AAID;;AACD,cAAMpD,sBAAsB,CAAC,MAAD,CAA5B;AACD;AA3De;AA4DjB;;AA1X8B;;AA6XjCwF,MAAM,CAACC,OAAP,GAAiBpF,0BAAjB","sourcesContent":["'use strict';\n\nconst chalk = require('chalk');\nconst _ = require('lodash');\nconst updateNotifier = require('update-notifier');\nconst {\n  configureFetchDefaults,\n  getLoggedInUser,\n  openBrowser,\n} = require('@serverless/platform-sdk');\nconst sfePkgJson = require('../package');\nconst errorHandler = require('./errorHandler');\nconst logsCollection = require('./logsCollection');\nconst login = require('./login');\nconst logout = require('./logout');\nconst wrap = require('./wrap');\nconst injectLogsIamRole = require('./injectLogsIamRole');\nconst injectOutputOutputs = require('./injectOutputOutputs');\nconst wrapClean = require('./wrapClean');\nconst runPolicies = require('./safeguards');\nconst getCredentials = require('./credentials');\nconst getAppUids = require('./appUids');\nconst removeDestination = require('./removeDestination');\nconst { saveDeployment, createAndSetDeploymentUid } = require('./deployment');\nconst variables = require('./variables');\nconst { generate, eventDict } = require('./generateEvent');\nconst { configureDeployProfile } = require('./deployProfile');\nconst { test } = require('./test');\nconst { getDashboardUrl } = require('./dashboard');\nconst setApiGatewayAccessLogFormat = require('./setApiGatewayAccessLogFormat');\nconst interactiveCli = require('./interactiveCli');\n\n/*\n * Serverless Enterprise Plugin\n */\n\nclass ServerlessEnterprisePlugin {\n  constructor(sls) {\n    this.sls = sls;\n\n    // Defaults\n    this.state = {}; // Useful for storing data across hooks\n    this.state.secretsUsed = new Set();\n\n    // forward compatibility with org\n    sls.service.tenant = sls.service.org || sls.service.tenant;\n\n    configureFetchDefaults();\n\n    // Configure commands available to logged out users\n    this.commands = {\n      'login': {\n        usage: 'Login or sign up for Serverless',\n        lifecycleEvents: ['login'],\n        enterprise: true,\n      },\n      'logout': {\n        usage: 'Logout from Serverless',\n        lifecycleEvents: ['logout'],\n        enterprise: true,\n      },\n      'generate-event': {\n        usage: 'Generate event',\n        lifecycleEvents: ['generate-event'],\n        options: {\n          type: {\n            usage: `Specify event type. ${_.keys(eventDict).join(', ')} are supported.`,\n            shortcut: 't',\n            required: true,\n          },\n          body: {\n            usage: 'Specify the body for the message, request, or stream event.',\n            shortcut: 'b',\n          },\n        },\n        enterprise: true,\n      },\n      'test': {\n        usage: 'Run HTTP tests',\n        lifecycleEvents: ['test'],\n        options: {\n          function: {\n            usage: 'Specify the function to test',\n            shortcut: 'f',\n          },\n          test: {\n            usage: 'Specify a specific test to run',\n            shortcut: 't',\n          },\n        },\n        enterprise: true,\n      },\n      'dashboard': {\n        usage: 'Open the Serverless dashboard',\n        lifecycleEvents: ['dashboard'],\n        enterprise: true,\n      },\n    };\n    this.hooks = {\n      'login:login': this.route('login:login').bind(this),\n      'logout:logout': this.route('logout:logout').bind(this),\n      'generate-event:generate-event': this.route('generate-event:generate-event').bind(this),\n      'test:test': this.route('test:test').bind(this),\n      'dashboard:dashboard': this.route('dashboard:dashboard').bind(this),\n      // behavior is conditional on this.sls.enterpriseEnabled\n      'after:aws:deploy:finalize:cleanup': this.route('after:aws:deploy:finalize:cleanup').bind(\n        this\n      ),\n    };\n    this.variableResolvers = {\n      param: {\n        resolver: variables.getValueFromDashboardParams(this),\n        serviceName: 'Serverless Parameters',\n        isDisabledAtPrepopulation: true,\n      },\n      secrets: {\n        resolver: variables.getValueFromDashboardParams(this),\n        serviceName: 'Serverless Secrets',\n        isDisabledAtPrepopulation: true,\n      },\n      output: {\n        resolver: variables.getValueFromDashboardOutputs(this),\n        serviceName: 'Serverless Outputs',\n        isDisabledAtPrepopulation: true,\n      },\n      state: {\n        resolver: variables.getValueFromDashboardOutputs(this),\n        serviceName: 'Serverless Outputs',\n        isDisabledAtPrepopulation: true,\n      },\n    };\n\n    // set allowed plugin options\n    for (const plugin of sls.pluginManager.plugins) {\n      if (plugin.constructor.name === 'InteractiveCli' && plugin.commands) {\n        if (!plugin.commands.interactiveCli.options) {\n          plugin.commands.interactiveCli.options = {};\n        }\n        plugin.commands.interactiveCli.options.app = { usage: 'Dashboard app' };\n        plugin.commands.interactiveCli.options.org = { usage: 'Dashboard org' };\n      } else if (plugin.commands) {\n        for (const command of _.values(plugin.commands)) {\n          if (command.configDependent) {\n            command.options.app = { usage: 'Dashboard app' };\n            command.options.org = { usage: 'Dashboard org' };\n          }\n        }\n      }\n    }\n    // Also adding in commands object of plugin man bc generating help doesn't reread the plugin\n    // itself\n    for (const command of _.values(sls.pluginManager.commands)) {\n      if (command.configDependent) {\n        command.options.app = { usage: 'Dashboard app' };\n        command.options.org = { usage: 'Dashboard org' };\n      }\n    }\n\n    // Add interactive CLI hooks\n    Object.assign(this.hooks, interactiveCli(this));\n\n    // Check if dashboard is configured\n    const missing = [];\n    if (!sls.service.tenant) {\n      missing.push('tenant');\n    }\n    if (!sls.service.app) {\n      missing.push('app');\n    }\n    if (!sls.service.service) {\n      missing.push('service');\n    }\n    if (missing.length > 0) {\n      // user isn't configured to use SFE\n      Object.assign(this.hooks, {\n        'after:aws:deploy:finalize:cleanup': () =>\n          sls.cli.log(\n            'Run the \"serverless\" command to setup monitoring, troubleshooting and testing.'\n          ),\n      });\n      this.sfeEnabledHooks = {};\n    } else {\n      if (\n        sls.service.app.match(new RegExp(sls.service.provider.variableSyntax)) ||\n        sls.service.tenant.match(new RegExp(sls.service.provider.variableSyntax))\n      ) {\n        throw new this.sls.classes.Error(\n          '\"app\" and \"org\" in your serverless config can not use the variable system'\n        );\n      }\n\n      this.sfeEnabledHooks = {\n        'before:package:createDeploymentArtifacts': this.route(\n          'before:package:createDeploymentArtifacts'\n        ).bind(this),\n        'after:package:createDeploymentArtifacts': this.route(\n          'after:package:createDeploymentArtifacts'\n        ).bind(this),\n        'before:deploy:function:packageFunction': this.route(\n          'before:deploy:function:packageFunction'\n        ).bind(this),\n        'after:deploy:function:packageFunction': this.route(\n          'after:deploy:function:packageFunction'\n        ).bind(this),\n        'before:invoke:local:invoke': this.route('before:invoke:local:invoke').bind(this),\n        'before:aws:package:finalize:saveServiceState': this.route(\n          'before:aws:package:finalize:saveServiceState'\n        ).bind(this),\n        'before:deploy:deploy': this.route('before:deploy:deploy').bind(this),\n        'before:aws:deploy:deploy:createStack': this.route(\n          'before:aws:deploy:deploy:createStack'\n        ).bind(this),\n        'after:deploy:finalize': this.route('after:deploy:finalize').bind(this),\n        'after:deploy:deploy': this.route('after:deploy:deploy').bind(this),\n        'before:info:info': this.route('before:info:info').bind(this),\n        'after:info:info': this.route('after:info:info').bind(this),\n        'before:logs:logs': this.route('before:logs:logs').bind(this),\n        'before:metrics:metrics': this.route('before:metrics:metrics').bind(this),\n        'before:remove:remove': this.route('before:remove:remove').bind(this),\n        'after:remove:remove': this.route('after:remove:remove').bind(this),\n        'after:invoke:local:invoke': this.route('after:invoke:local:invoke').bind(this),\n        'before:offline:start:init': this.route('before:offline:start:init').bind(this),\n        'before:step-functions-offline:start': this.route(\n          'before:step-functions-offline:start'\n        ).bind(this),\n      };\n      // Set Plugin hooks for authenticated Enteprise Plugin features\n      Object.assign(this.hooks, this.sfeEnabledHooks);\n    }\n  }\n\n  /*\n   * Route\n   */\n\n  route(hook) {\n    return async () => {\n      // throw an error if SFE is disabled and running an SFE only hook\n      if (!this.sls.enterpriseEnabled && _.keys(this.sfeEnabledHooks).includes(hook)) {\n        const errorMessage = process.env.CI\n          ? 'You are not currently logged in. Follow instructions in http://slss.io/run-in-cicd to setup env vars for authentication.'\n          : 'You are not currently logged in. To log in, use: $ serverless login';\n        console.log(''); // eslint-disable-line no-console\n        this.sls.cli.log(errorMessage);\n        throw new this.sls.classes.Error(errorMessage);\n      }\n\n      switch (hook) {\n        case 'before:package:createDeploymentArtifacts':\n          Object.assign(\n            this.sls.service,\n            await getAppUids(this.sls.service.tenant, this.sls.service.app)\n          );\n          createAndSetDeploymentUid(this);\n          await wrap(this);\n          await injectLogsIamRole(this);\n          await injectOutputOutputs(this);\n          await setApiGatewayAccessLogFormat(this);\n          break;\n        case 'after:package:createDeploymentArtifacts':\n          await wrapClean(this);\n          break;\n        case 'before:deploy:function:packageFunction':\n          createAndSetDeploymentUid(this);\n          await wrap(this);\n          break;\n        case 'after:deploy:function:packageFunction':\n          await wrapClean(this);\n          break;\n        case 'before:aws:package:finalize:saveServiceState':\n          await getCredentials(this);\n          await logsCollection(this);\n          break;\n        case 'before:deploy:deploy':\n          this.enterprise = {\n            errorHandler: errorHandler(this), // V.1 calls this when it crashes\n          };\n          await runPolicies(this);\n          break;\n        case 'before:aws:deploy:deploy:createStack':\n          break;\n        case 'after:aws:deploy:finalize:cleanup':\n          if (!this.sls.enterpriseEnabled) {\n            this.sls.cli.log(\n              'Run the \"serverless\" command to setup monitoring, troubleshooting and testing.'\n            );\n          } else {\n            await saveDeployment(this);\n          }\n          break;\n        case 'before:info:info':\n          await getCredentials(this);\n          break;\n        case 'after:info:info':\n          // eslint-disable-next-line no-console\n          console.log(\n            chalk.yellow(\n              `Run \"serverless dashboard\" to open the dashboard or visit ${getDashboardUrl(this)}`\n            )\n          );\n          break;\n        case 'dashboard:dashboard':\n          openBrowser(getDashboardUrl(this));\n          break;\n        case 'before:logs:logs':\n          await getCredentials(this);\n          break;\n        case 'before:metrics:metrics':\n          await getCredentials(this);\n          break;\n        case 'before:remove:remove':\n          await getCredentials(this);\n          break;\n        case 'after:remove:remove':\n          Object.assign(\n            this.sls.service,\n            await getAppUids(this.sls.service.tenant, this.sls.service.app)\n          );\n          await removeDestination(this);\n          await saveDeployment(this, true);\n          break;\n        case 'before:invoke:local:invoke':\n          Object.assign(this.sls.service, {\n            appUid: '000000000000000000',\n            tenantUid: '000000000000000000',\n          });\n          await wrap(this);\n          break;\n        case 'after:invoke:local:invoke':\n          await wrapClean(this);\n          break;\n        case 'before:offline:start:init':\n          // await wrap(this)\n          break;\n        case 'before:step-functions-offline:start':\n          // await wrap(this)\n          break;\n        case 'login:login':\n          await login(this);\n          break;\n        case 'logout:logout':\n          await logout(this);\n          break;\n        case 'generate-event:generate-event':\n          await generate(this);\n          break;\n        case 'test:test':\n          await test(this);\n          break;\n        default:\n      }\n    };\n  }\n\n  async asyncInit() {\n    if (\n      this.sls.processedInput.options['help-interactive'] ||\n      this.sls.processedInput.options.help\n    ) {\n      return;\n    }\n    // Filter available projects to create\n    if (this.sls.interactiveCli && this.sls.interactiveCli.initializeServiceConfiguration) {\n      this.sls.interactiveCli.initializeServiceConfiguration.initializeProjectChoices = this.sls.interactiveCli.initializeServiceConfiguration.initializeProjectChoices.filter(\n        ({ value }) => ['aws-nodejs', 'aws-python3', 'aws-python'].includes(value)\n      );\n    }\n\n    // override app & tenant from CLI flags if set and not in interactive mode\n    if (!this.sls.interactiveCli) {\n      if (this.sls.processedInput.options.org) {\n        this.sls.service.tenant = this.sls.processedInput.options.org;\n      }\n      if (this.sls.processedInput.options.app) {\n        this.sls.service.app = this.sls.processedInput.options.app;\n      }\n    }\n    const missingConfigSettings = [];\n    if (!this.sls.service.tenant) {\n      missingConfigSettings.push('tenant');\n    }\n    if (!this.sls.service.app) {\n      missingConfigSettings.push('app');\n    }\n    if (!this.sls.service.service) {\n      missingConfigSettings.push('service');\n    }\n    const user = getLoggedInUser();\n    const currentCommand = this.sls.processedInput.commands[0];\n    if (\n      missingConfigSettings.length === 0 &&\n      (user || process.env.SERVERLESS_ACCESS_KEY) &&\n      !['login', 'logout', 'generate-event'].includes(currentCommand)\n    ) {\n      this.sls.enterpriseEnabled = true;\n    }\n    // this.provider, intentionally not set in constructor, as then it affects plugin validation\n    // in serverless, which will discard plugin when command not run in service context:\n    // https://github.com/serverless/serverless/blob/f0ccf6441ace7b5cc524e774f025a39c3c0667f2/lib/classes/PluginManager.js#L78\n    this.provider = this.sls.getProvider('aws');\n    if (\n      !this.sls.interactiveCli &&\n      this.sls.enterpriseEnabled &&\n      !this.sls.isStandaloneExecutable\n    ) {\n      const updates = updateNotifier({ pkg: sfePkgJson, interval: 1 });\n      if (updates.update) {\n        this.sls.cli.log(\n          'An updated version of the Serverless Dashboard is available. ' +\n            'Please upgrade by running `npm i -g serverless`'\n        );\n      }\n      await configureDeployProfile(this);\n    }\n  }\n}\n\nmodule.exports = ServerlessEnterprisePlugin;\n"],"file":"plugin.js"}